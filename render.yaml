services:
  # Single Service - Backend + Frontend
  - type: web
    name: videoconference-app
    env: node
    plan: starter
    buildCommand: |
      set -e
      echo "==> Current directory: $(pwd)"
      echo "==> Listing root directory contents:"
      ls -la
      echo ""
      echo "==> Building server..."
      cd server
      npm ci
      npm run build
      echo "==> Server dist contents:"
      ls -la dist/
      cd ..
      echo ""
      echo "==> Building client..."
      cd client
      npm ci
      npm run build
      echo "==> Client dist contents:"
      ls -la dist/
      cd ..
      echo ""
      echo "==> Current location: $(pwd)"
      echo "==> Creating public directory..."
      mkdir -p server/dist/public
      echo "==> Copying client build to server/dist/public/..."
      cp -rv client/dist/* server/dist/public/
      echo "==> Verifying copy completed..."
      ls -la server/dist/public/
      echo "==> Checking if index.html exists:"
      test -f server/dist/public/index.html && echo "✅ index.html found!" || echo "❌ index.html NOT found!"
      echo "==> Build complete!"
    startCommand: |
      echo "==> Preparing to start server..."
      echo "==> Current directory: $(pwd)"
      echo "==> Checking for client build..."
      if [ -d "client/dist" ]; then
        echo "==> Client dist found, copying to server/dist/public/..."
        mkdir -p server/dist/public
        cp -rv client/dist/* server/dist/public/
        echo "==> Verification - files in server/dist/public/:"
        ls -la server/dist/public/
      else
        echo "==> WARNING: client/dist not found!"
        ls -la client/ || echo "client directory not found"
      fi
      echo "==> Starting server..."
      cd server && npm start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: JWT_SECRET
        generateValue: true
      - key: CORS_ORIGIN
        value: "*"
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"
      - key: DATA_DIR
        value: "/var/data"
      - key: ADMIN_EMAIL
        value: "admin@example.com"
      - key: ADMIN_PASSWORD
        generateValue: true
    disk:
      name: videoconference-data
      mountPath: /var/data
      sizeGB: 1

databases: []